

key uuid string;

key value int;

key date string;

key other_thing string;

datasource db (
    uuid:uuid,
    value:value,
    date:date,
    other_thing:other_thing,
)
address db;


auto max_val <- max(value) by uuid;
auto min_val <- min(value) by uuid;

auto ratio <- max_val / min_val;


RAW_SQL('''
CREATE TABLE db (
    uuid UUID,
    value INT,
    date DATE,
    other_thing STRING
);
INSERT INTO db
VALUES
    ('00000000-0000-0000-0000-000000000001', 1, '2024-01-01', 'fun'),
    ('00000000-0000-0000-0000-000000000002', 2, '2024-01-01', 'b'),
    ('00000000-0000-0000-0000-000000000003', 3, '2024-01-01', 'c'),
    ('00000000-0000-0000-0000-000000000003', 4, '2024-01-01', 'd'),
    ('00000000-0000-0000-0000-000000000001', 3, '2024-01-01', 'e'),
    ('00000000-0000-0000-0000-000000000002', 8, '2024-01-01', 'f'),
    ('00000000-0000-0000-0000-000000000006', 8, '2024-01-01', 'fun'),
    ('00000000-0000-0000-0000-000000000007', 8, '2024-01-01', 'h'),
    ('00000000-0000-0000-0000-000000000008', 8, '2024-01-01', 'i'),
    ('00000000-0000-0000-0000-000000000010', 12, '2024-01-01', 'j'),
    ('00000000-0000-0000-0000-000000000011', 12, '2024-01-01', 'fun'),
    ('00000000-0000-0000-0000-000000000067', 12, '2024-01-01', 'fun'),
    ('00000000-0000-0000-0000-000000000012', 12, '2024-01-01', 'fun'),
    ('00000000-0000-0000-0000-000000000045', 12, '2024-01-01', 'fun')
;
''');

SELECT 
    other_thing,
    date,
    avg(ratio) -> avg_deletion_rate
WHERE
    date = '2024-01-01'
;

