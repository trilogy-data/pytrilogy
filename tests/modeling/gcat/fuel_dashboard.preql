import launch;

auto stage_identifier <-  CASE WHEN vehicle.name != vehicle.stage.name THEN CASE WHEN vehicle.variant != '-' THEN concat(vehicle.name,'-',vehicle.variant)
ELSE vehicle.name
END
ELSE vehicle.name
END;

auto era <-
  CASE
        WHEN launch_date.year < 1975 THEN 'Space Race'
        WHEN launch_date.year BETWEEN 1975 AND 2000 THEN 'Post Apollo'
        ELSE 'Modern'
    END;



datasource fuel_aggregates (
  launch_tag:?launch_tag,
  launch_code:_launch_code,
  orb_pay:?orb_pay,
  org_code:?org.code,
  org_state_code:?org.state_code,
  org_hex:?org.hex,
  vehicle_stage_engine_name:?vehicle.stage.engine.name,
  vehicle_stage_engine_fuel:?vehicle.stage.engine.fuel,
  vehicle_stage_engine_oxidizer: ?vehicle.stage.engine.oxidizer,
  vehicle_stage_engine_group:?vehicle.stage.engine.group,
  stage_no: vehicle.stage_no,
  stage_name: vehicle.stage.name,
  lv_type: vehicle.name,
  lv_variant: vehicle.variant,
  launch_date_year:?launch_date.year,
  launch_jd:?launch_jd,
)
grain (launch_tag, vehicle.stage_no, vehicle.name, vehicle.variant)
address fuel_dashboard_agg;

validate datasources fuel_aggregates;