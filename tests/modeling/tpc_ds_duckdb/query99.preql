#For catalog sales, create a report showing the counts of orders shipped within 30 days, from 31 to 60 days, from
#61 to 90 days, from 91 to 120 days and over 120 days within a given year, grouped by warehouse, call center
# and shipping mode.


import catalog_sales as catalog_sales;

auto warehouse_short_name <- substring(catalog_sales.warehouse.name, 1, 20);
# auto cc_name_lower <- lower(catalog_sales.call_center.name);
auto catalog_pk <- catalog_sales.order_number::string || catalog_sales.item.id::string;

WHERE catalog_sales.ship_date.month_seq BETWEEN 1200 and 1211
SELECT
    warehouse_short_name,
    catalog_sales.ship_mode.type,
    lower(catalog_sales.call_center.name) ->cc_name_lower,
    COUNT(catalog_pk ? catalog_sales.days_to_ship <= 30) AS less_than_30_days,
    COUNT(catalog_pk ?  catalog_sales.days_to_ship > 30 AND catalog_sales.days_to_ship <= 60) AS between_31_and_60_days,
    COUNT(catalog_pk ?  catalog_sales.days_to_ship > 60 AND catalog_sales.days_to_ship <= 90) AS between_61_and_90_days,
    COUNT(catalog_pk ?  catalog_sales.days_to_ship > 90 AND catalog_sales.days_to_ship <= 120) AS between_91_and_120_days,
    COUNT(catalog_pk ?  catalog_sales.days_to_ship > 120) AS over_120_days
ORDER BY
    warehouse_short_name asc nulls first,
    catalog_sales.ship_mode.type asc nulls first,
    cc_name_lower asc nulls first;
