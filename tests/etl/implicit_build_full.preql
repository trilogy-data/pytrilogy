# script to update our aggregate table
# partitioned by year, month
# updates one year at a time
import root;

parameter load_year int; # the year of data to load into the daily fact table;

# Basic aggregation concepts
auto total_rides <- COUNT(ride_id);
auto total_riders <- COUNT(rider_id);
auto total_distance_miles <- ROUND(SUM(distance_miles), 2);
auto total_duration_minutes <- ROUND(SUM(duration_minutes), 2);
auto total_duration_hours <- ROUND(SUM(duration_minutes) / 60, 2);
auto total_calories_burned <- ROUND(SUM(calories_burned), 0);

# Average metric concepts
auto avg_distance_per_ride <- ROUND(AVG(distance_miles), 2);
auto avg_duration_per_ride <- ROUND(AVG(duration_minutes), 2);
auto avg_ride_avg_speed_mph <- ROUND(AVG(avg_speed_mph), 2);
auto avg_fun_rating <- ROUND(AVG(fun_rating), 2);
auto avg_temp_f <- ROUND(AVG(temp_f), 1);

# Weather boolean flag concepts
auto had_sunny_weather <- BOOL_OR(weather = 'Sunny');
auto had_rainy_weather <- BOOL_OR(weather = 'Light Rain');
auto had_windy_weather <- BOOL_OR(weather = 'Windy');
auto had_poor_weather <- BOOL_OR(weather IN ('Light Rain', 'Overcast'));

# Ride type boolean flag concepts
auto had_commute_rides <- BOOL_OR(ride_type LIKE '%Commute%');
auto had_adventure_rides <- BOOL_OR(ride_type LIKE '%Adventure%');
auto had_training_rides <- BOOL_OR(ride_type LIKE '%Training%');

# Performance boolean flag concepts
auto had_long_rides <- BOOL_OR(distance_miles > 20);
auto had_fast_rides <- BOOL_OR(avg_speed_mph > 15);
auto had_high_fun_rides <- BOOL_OR(fun_rating >= 8);
auto had_high_calorie_rides <- BOOL_OR(calories_burned > 500);

# Bike type diversity concepts
auto bike_types_used <- COUNT(bike_type);
auto had_ebike_rides <- BOOL_OR(bike_type = 'E-bike');
auto had_mountain_bike_rides <- BOOL_OR(bike_type = 'Mountain Bike');

# Location diversity concepts
auto locations_used <- COUNT(start_location);
auto had_park_rides <- BOOL_OR(start_location LIKE '%Park%');

# Temperature category concepts
auto had_cold_rides <- BOOL_OR(temp_f < 40);
auto had_hot_rides <- BOOL_OR(temp_f > 75);

datasource daily_fact(
    ride_year,
    ride_month,
    total_rides,
    total_riders,
    total_distance_miles,
    total_duration_minutes,
    total_duration_hours,
    total_calories_burned,
    avg_distance_per_ride,
    avg_duration_per_ride,
    avg_ride_avg_speed_mph,
    avg_fun_rating,
    avg_temp_f,
    had_sunny_weather,
    had_rainy_weather,
    had_windy_weather,
    had_poor_weather,
    had_commute_rides,
    had_adventure_rides,
    had_training_rides,
    had_long_rides,
    had_fast_rides,
    had_high_fun_rides,
    had_high_calorie_rides,
    bike_types_used,
    had_ebike_rides,
    had_mountain_bike_rides,
    locations_used,
    had_park_rides,
    had_cold_rides,
    had_hot_rides
    )
grain (ride_year, ride_month)
address tbl_daily_fact
;

create if not exists datasources daily_fact;


# test a full overwrite
OVERWRITE daily_fact
;

# test an append
APPEND daily_fact
WHERE ride_year = load_year
;