import orders as order;
import inventory_items as inventory_item;
import users as user;

key id int;
property id.status string;
property id.created_at timestamp;
property id.shipped_at timestamp;
property id.delivered_at timestamp;
property id.returned_at timestamp;
property id.sale_price float;


auto revenue <- order.item_count * sale_price;
auto cost <- inventory_item.product.cost * order.item_count;
auto total_revenue <- sum(revenue);
auto total_sold <- sum(order.item_count);
auto total_cost <- ROUND(SUM(cost), 2);
auto total_margin <- ROUND(SUM(revenue) - SUM(cost), 2);
auto item_quantity <- group(order.item_count) by id; # quantity per row item
auto total_quantity <- SUM(item_quantity);

auto order.user.id.first_purchase_date <- min(order.created_at.date) by order.user.id;
auto order.user.id.latest_purchase_date <- max(order.created_at.date) by order.user.id;

auto customer_status <- case
		when order.user.id.first_purchase_date = order.user.id.latest_purchase_date
			then "New"
		else "Returning"
		end;

datasource order_items (
    id:id,
	order_id:order.id,
	user_id:user.id,
	product_id:inventory_item.product.id,
	inventory_item_id:inventory_item.id,
	status,
	created_at,
	shipped_at,
	delivered_at,
	returned_at,
	sale_price,
    ) 
grain (id) 
address `bigquery-public-data.thelook_ecommerce.order_items`;
